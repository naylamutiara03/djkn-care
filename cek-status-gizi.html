<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="img/logo-djkn.png">
    <title>Cek Status Gizi Anak - DJKN Care</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

    <style>
        /* ===================================================== */
        /* ROOT COLOR VARIABLES */
        /* ===================================================== */
        :root {
            --color-primary: #006838;
            --color-secondary: #8cc342;
            --color-success-dark: #176f4e;
            --color-bg-light: #f7f7f7;
        }

        /* ===================================================== */
        /* BASE LAYOUT */
        /* ===================================================== */
        body {
            background: linear-gradient(to top, #badc84 50%, #d4eb95 100%);
            min-height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 80px;
            padding-bottom: 20px;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        .gizi-container {
            max-width: 820px;
            width: 95%;
            background: #fff;
            padding: 30px 22px;
            border-radius: 15px;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
            margin-top: 10px;
        }

        .gizi-container h1 {
            color: #4a6c38;
            font-weight: 700;
            margin-bottom: 25px;
            font-size: 1.8rem;
        }

        /* ===================================================== */
        /* NAVBAR */
        /* ===================================================== */
        .navbar {
            width: 100%;
            z-index: 1030;
        }

        .brand-logo {
            height: 50px;
        }

        .brand-text {
            font-size: 1.6rem;
            font-weight: 700;
        }

        .stikes-logo {
            height: 36px;
        }

        /* ===================================================== */
        /* CONTENT */
        /* ===================================================== */
        .content-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .image-section {
            width: 100%;
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
        }

        .image-section img {
            width: 170px;
        }

        .input-section {
            width: 100%;
        }

        /* ===================================================== */
        /* INPUT CARD */
        /* ===================================================== */
        .input-group-custom {
            background: var(--color-bg-light);
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .input-group-custom:focus-within {
            background: #fff;
            box-shadow: 0 0 0 2px var(--color-secondary);
        }

        .input-group-custom label {
            font-weight: 500;
            font-size: 1rem;
            margin: 0;
        }

        .input-group-custom i {
            color: #4a6c38;
            font-size: 1.25rem;
        }

        /* INPUT VALUE */
        .input-value-custom {
            border: none;
            background: transparent;
            outline: none;
            text-align: right;
            font-weight: 600;
            width: 90px;
        }

        /* SELECT */
        .form-select-custom {
            border: none;
            background: transparent;
            outline: none;
            font-weight: 600;
            padding-right: 25px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%234a6c38' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 5px center;
        }

        .gizi-container h1 {
            color: #4a6c38;
            font-weight: 700;
            margin-bottom: 25px;
            font-size: 1.8rem;
            text-align: center;
        }


        /* ===================================================== */
        /* BUTTON */
        /* ===================================================== */
        .btn-hitung {
            width: 100%;
            margin-top: 25px;
            padding: 14px;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: 12px;
            background: var(--color-success-dark);
            color: #fff;
            border: none;
            transition: 0.2s;
        }

        .btn-hitung:hover {
            background: #12573d;
            transform: translateY(-2px);
        }

        /* ===================================================== */
        /* DESKTOP (>= 768px) */
        /* ===================================================== */
        @media (min-width: 768px) {
            .content-wrapper {
                flex-direction: row;
                align-items: flex-start;
                gap: 40px;
            }

            .image-section {
                width: 40%;
                margin-top: 60px;
            }

            .image-section img {
                width: 240px;
            }

            .input-section {
                width: 60%;
            }

            .gizi-container {
                padding: 45px 50px;
            }

            .gizi-container h1 {
                font-size: 2.2rem;
            }
        }

        /* ===================================================== */
        /* MOBILE OPTIMIZATION (<= 576px) */
        /* ===================================================== */
        @media (max-width: 576px) {

            body {
                padding-top: 70px;
            }

            .gizi-container {
                padding: 20px 15px;
                border-radius: 12px;
            }

            .gizi-container h1 {
                font-size: 1.4rem;
                margin-bottom: 18px;
            }

            .image-section img {
                width: 135px;
            }

            /* INPUT CARD -> VERTICAL */
            .input-group-custom {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .input-group-custom>div {
                width: 100%;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .input-value-custom {
                width: 100%;
                text-align: right;
                font-size: 1rem;
            }

            .form-select-custom {
                width: 100%;
                font-size: 0.95rem;
            }

            .btn-hitung {
                font-size: 1.1rem;
                padding: 14px;
                border-radius: 10px;
            }

            .brand-logo {
                height: 40px;
            }

            .stikes-logo {
                height: 30px;
            }
        }

        /* ===================================================== */
        /* MODAL & CHART */
        /* ===================================================== */
        .modal-header.bg-laki-laki {
            background-color: #0d6efd !important;
        }

        .modal-header.bg-perempuan {
            background-color: #e83e8c !important;
        }

        .modal-header.bg-success {
            background-color: var(--color-success-dark) !important;
        }

        .chart-container {
            width: 100%;
            height: 40vh;
        }

        @media (min-width: 768px) {
            .chart-container {
                height: 50vh;
                max-height: 450px;
            }
        }

        /* ===================================================== */
        /* MOBILE FIX TOTAL â€“ INPUT CARD */
        /* ===================================================== */
        @media (max-width: 576px) {

            /* Card jadi vertical */
            .input-group-custom {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
                padding: 16px 16px;
                border-radius: 14px;
            }

            /* Label full width di atas */
            .input-group-custom label {
                width: 100%;
                font-size: 0.95rem;
                font-weight: 600;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

            /* Row icon + input */
            .input-group-custom>div {
                width: 100%;
                display: flex;
                align-items: center;
                gap: 12px;
            }

            /* Icon fix position */
            .input-group-custom i {
                font-size: 1.2rem;
                flex-shrink: 0;
                color: var(--color-primary);
            }

            /* Input number */
            .input-value-custom {
                flex: 1;
                width: 100%;
                font-size: 1.05rem;
                text-align: right;
            }

            /* Hilangkan arrow bawaan browser */
            select {
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                background-color: transparent;
            }

            /* Pastikan arrow custom tetap rapi */
            .form-select-custom {
                background-position: right 8px center;
                padding-right: 30px;
            }

            /* Button */
            .btn-hitung {
                font-size: 1.15rem;
                padding: 16px;
                border-radius: 12px;
            }
        }
    </style>

</head>

<body>

    <nav class="navbar navbar-light bg-light fixed-top shadow-sm">
        <div class="container-fluid">
            <div class="d-flex align-items-center">

                <a href="index.html" class="back-link me-3 ms-2" title="Kembali">
                    <i class="bi bi-arrow-left" style="color: var(--color-primary);"></i>
                </a>

                <a class="navbar-brand d-flex align-items-center" href="index.html">
                    <img src="img/logo-djkn.png" alt="DJKN Logo" class="brand-logo me-2">
                    <span style="font-size: 1.8rem; font-weight: 700;">
                        <span style="color: #006838;">DJKN</span><span style="color: #8cc342;">-CARE</span>
                    </span>
                </a>
            </div>

            <div class="d-flex align-items-center">
                <img src="img/logo-stikes.png" alt="STIKES Logo" class="stikes-logo me-2">
            </div>
        </div>
    </nav>

    <div class="gizi-container">
        <h1 class="text-success">Cek Status Gizi Anak</h1>

        <div class="content-wrapper">

            <div class="image-section">
                <img src="img/bayi.png" alt="Ilustrasi Anak Sehat" class="img-fluid">
            </div>

            <div class="input-section">

                <div class="input-group-custom">
                    <label for="kategoriIndex" class="d-flex align-items-center mb-0 me-2">
                        Kategori Index
                        <i class="bi bi-info-circle ms-2" data-bs-toggle="modal" data-bs-target="#indexInfoModal"></i>
                    </label>
                    <select id="kategoriIndex" class="form-select-custom flex-shrink-0" required>
                        <option value="" disabled selected>Pilih Kategori Index</option>
                        <option value="BB/U">BB/U (Berat Badan / Usia)</option>
                        <option value="TB/U">TB/U (Tinggi Badan / Usia)</option>
                        <option value="BB/TB">BB/TB (Berat Badan / Tinggi Badan)</option>
                    </select>
                </div>

                <div class="input-group-custom">
                    <label for="jenisKelamin" class="d-flex align-items-center mb-0 me-2">
                        Jenis Kelamin
                    </label>
                    <div class="d-flex align-items-center">
                        <i class="bi bi-person-circle me-2"></i>
                        <select id="jenisKelamin" class="form-select-custom" required>
                            <option value="" disabled selected>Pilih Jenis Kelamin</option>
                            <option value="L">Laki-laki</option>
                            <option value="P">Perempuan</option>
                        </select>
                    </div>
                </div>

                <div class="input-group-custom">
                    <label for="beratBadan" class="mb-0 me-2">Berat Badan (kg)</label>
                    <div class="d-flex align-items-center">
                        <i class="bi bi-speedometer2 me-2"></i>
                        <input type="number" id="beratBadan" placeholder="0.0" min="0" step="0.1" required
                            class="input-value-custom flex-shrink-0">
                    </div>
                </div>

                <div class="input-group-custom">
                    <label for="tinggiBadan" class="mb-0 me-2">Tinggi Badan (cm)</label>
                    <div class="d-flex align-items-center">
                        <i class="bi bi-rulers me-2"></i>
                        <input type="number" id="tinggiBadan" placeholder="0.0" min="0" step="0.1" required
                            class="input-value-custom flex-shrink-0">
                    </div>
                </div>

                <div class="input-group-custom">
                    <label for="usiaBulan" class="mb-0 me-2">Usia (bulan)</label>
                    <div class="d-flex align-items-center">
                        <i class="bi bi-calendar-date me-2"></i>
                        <input type="number" id="usiaBulan" placeholder="0" min="0" max="60" step="1" required
                            class="input-value-custom flex-shrink-0">
                    </div>
                </div>

                <button class="btn btn-hitung" onclick="hitungGizi()">HITUNG STATUS GIZI</button>
            </div>

        </div>
    </div>

    <div class="modal fade" id="indexInfoModal" tabindex="-1" aria-labelledby="indexInfoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="indexInfoModalLabel"><i class="bi bi-info-circle me-2"></i>Informasi
                        Kategori Index Gizi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body text-start">
                    <p>Kategori Index Gizi digunakan untuk menentukan status gizi anak:</p>

                    <ul>
                        <li>
                            <p><strong>BB/U (Berat Badan menurut Usia)</strong>: Mengukur kekurangan atau kelebihan
                                berat badan (kurus atau gemuk) pada usia tertentu. Indikator status gizi umum.</p>
                        </li>
                        <li>
                            <p><strong>TB/U (Tinggi Badan menurut Usia)</strong>: Menilai tinggi badan yang kurang
                                (stunting) atau normal. Mencerminkan masalah gizi kronis.</p>
                        </li>
                        <li>
                            <p><strong>BB/TB (Berat Badan menurut Tinggi Badan)</strong>: Menilai berat badan yang
                                kurang (wasting) atau berlebihan (obesitas) untuk tinggi badannya.
                                Mencerminkan masalah gizi akut.</p>
                        </li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="hasilModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header text-white" id="hasilModalHeader">
                    <h5 class="modal-title"><i class="bi bi-graph-up"></i> Hasil Status Gizi Anak
                        <span id="jenisKelaminJudul"></span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <h5 class="text-center fw-bold mb-4" id="kategoriHasil"></h5>

                    <h6 class="text-start" id="grafikSubjudul"></h6>
                    <div class="chart-container">
                        <canvas id="grafikZscore"></canvas>
                    </div>

                    <small class="text-muted text-start mt-3 d-block">Garis tengah (Median) mewakili rata-rata populasi
                        rujukan WHO.</small>
                    <small class="text-muted text-start d-block fw-bold">Mohon Screenshot grafik untuk menyimpan data
                        IMT anak Anda.</small>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Selesai</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="errorModalLabel"><i class="bi bi-x-octagon me-2"></i>Kesalahan Input
                        Data</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body text-start">
                    <p id="errorMessage"></p>
                    <p class="text-muted"><small>Silakan periksa kembali semua kolom input.</small></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">OK, Tutup</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const WHO_DATA = {
            // Data WHO yang telah disediakan
            "BB/U_L": { 0: { m: 3.3, sd3neg: 2.4, sd2neg: 2.9, sd1neg: 3.8, median: 4.5, sd1: 5.2, sd2: 5.8, sd3: 6.5 }, 12: { m: 9.6, sd3neg: 7.0, sd2neg: 7.8, sd1neg: 8.7, median: 10.2, sd1: 11.5, sd2: 12.8, sd3: 14.1 }, 24: { m: 12.2, sd3neg: 9.0, sd2neg: 10.1, sd1neg: 11.2, median: 13.0, sd1: 14.8, sd2: 16.7, sd3: 18.5 }, 36: { m: 14.3, sd3neg: 10.5, sd2neg: 11.8, sd1neg: 13.2, median: 15.5, sd1: 17.8, sd2: 20.0, sd3: 22.3 }, 48: { m: 16.3, sd3neg: 12.0, sd2neg: 13.5, sd1neg: 15.0, median: 17.8, sd1: 20.5, sd2: 23.3, sd3: 26.0 }, 60: { m: 18.3, sd3neg: 13.5, sd2neg: 15.2, sd1neg: 17.0, median: 20.2, sd1: 23.5, sd2: 26.8, sd3: 30.1 } },
            "BB/U_P": { 0: { m: 3.2, sd3neg: 2.3, sd2neg: 2.8, sd1neg: 3.6, median: 4.2, sd1: 4.9, sd2: 5.5, sd3: 6.1 }, 12: { m: 9.0, sd3neg: 6.5, sd2neg: 7.3, sd1neg: 8.2, median: 9.8, sd1: 11.1, sd2: 12.5, sd3: 13.8 }, 24: { m: 11.5, sd3neg: 8.4, sd2neg: 9.5, sd1neg: 10.6, median: 12.5, sd1: 14.3, sd2: 16.1, sd3: 17.9 }, 36: { m: 13.5, sd3neg: 9.8, sd2neg: 11.1, sd1neg: 12.5, median: 14.7, sd1: 17.0, sd2: 19.3, sd3: 21.6 }, 48: { m: 15.4, sd3neg: 11.3, sd2neg: 12.7, sd1neg: 14.2, median: 17.0, sd1: 19.8, sd2: 22.5, sd3: 25.3 }, 60: { m: 17.2, sd3neg: 12.6, sd2neg: 14.2, sd1neg: 15.9, median: 19.1, sd1: 22.3, sd2: 25.5, sd3: 28.7 } },
            "TB/U_L": { 0: { m: 49.9, sd3neg: 46.1, sd2neg: 47.4, sd1neg: 48.7, median: 51.0, sd1: 52.3, sd2: 53.6, sd3: 54.9 }, 12: { m: 76.1, sd3neg: 69.8, sd2neg: 72.3, sd1neg: 74.5, median: 78.0, sd1: 80.8, sd2: 83.1, sd3: 85.3 }, 24: { m: 87.1, sd3neg: 80.1, sd2neg: 82.8, sd1neg: 85.3, median: 89.2, sd1: 92.4, sd2: 95.1, sd3: 97.7 }, 36: { m: 95.7, sd3neg: 88.0, sd2neg: 90.8, sd1neg: 93.4, median: 98.2, sd1: 101.4, sd2: 104.2, sd3: 107.0 }, 48: { m: 102.6, sd3neg: 94.6, sd2neg: 97.5, sd1neg: 100.3, median: 105.4, sd1: 109.1, sd2: 112.1, sd3: 115.1 }, 60: { m: 108.4, sd3neg: 100.0, sd2neg: 103.0, sd1neg: 105.9, median: 111.3, sd1: 115.3, sd2: 118.6, sd3: 121.8 } },
            "TB/U_P": { 0: { m: 49.1, sd3neg: 45.4, sd2neg: 46.7, sd1neg: 47.9, median: 50.1, sd1: 51.4, sd2: 52.7, sd3: 54.0 }, 12: { m: 74.5, sd3neg: 68.2, sd2neg: 70.7, sd1neg: 72.9, median: 76.5, sd1: 79.2, sd2: 81.6, sd3: 83.8 }, 24: { m: 85.0, sd3neg: 78.1, sd2neg: 80.7, sd1neg: 83.1, median: 87.1, sd1: 90.2, sd2: 92.8, sd3: 95.3 }, 36: { m: 93.6, sd3neg: 86.0, sd2neg: 88.8, sd1neg: 91.3, median: 96.0, sd1: 99.1, sd2: 101.8, sd3: 104.5 }, 48: { m: 100.2, sd3neg: 92.3, sd2neg: 95.2, sd1neg: 97.9, median: 102.9, sd1: 106.5, sd2: 109.5, sd3: 112.4 }, 60: { m: 105.9, sd3neg: 97.6, sd2neg: 100.5, sd1neg: 103.3, median: 108.5, sd1: 112.3, sd2: 115.4, sd3: 118.5 } },
            "BB/TB_L": { 80: { m: 9.3, sd3neg: 7.7, sd2neg: 8.2, sd1neg: 8.7, median: 9.9, sd1: 10.7, sd2: 11.4, sd3: 12.2 }, 90: { m: 11.5, sd3neg: 9.3, sd2neg: 10.0, sd1neg: 10.7, median: 12.3, sd1: 13.3, sd2: 14.3, sd3: 15.3 }, 100: { m: 14.3, sd3neg: 11.5, sd2neg: 12.4, sd1neg: 13.3, median: 15.4, sd1: 16.7, sd2: 18.0, sd3: 19.3 }, 110: { m: 17.8, sd3neg: 14.2, sd2neg: 15.3, sd1neg: 16.5, median: 19.2, sd1: 20.8, sd2: 22.5, sd3: 24.2 } },
            "BB/TB_P": { 80: { m: 9.1, sd3neg: 7.5, sd2neg: 8.0, sd1neg: 8.5, median: 9.6, sd1: 10.4, sd2: 11.1, sd3: 11.9 }, 90: { m: 11.2, sd3neg: 9.1, sd2neg: 9.7, sd1neg: 10.4, median: 12.0, sd1: 13.0, sd2: 13.9, sd3: 14.9 }, 100: { m: 13.9, sd3neg: 11.1, sd2neg: 11.9, sd1neg: 12.8, median: 15.0, sd1: 16.2, sd2: 17.5, sd3: 18.7 }, 110: { m: 17.3, sd3neg: 13.7, sd2neg: 14.8, sd1neg: 15.9, median: 18.7, sd1: 20.2, sd2: 21.8, sd3: 23.4 } }
        };

        let myChart; // Variabel global untuk instance chart

        // Fungsi interpolasi linear sederhana
        function interpolate(x, x1, y1, x2, y2) {
            if (x1 === x2) return y1;
            return y1 + (x - x1) * (y2 - y1) / (x2 - x1);
        }

        // Fungsi untuk mendapatkan data WHO yang diinterpolasi
        function getWhoData(indexKey, paramValue) {
            const data = WHO_DATA[indexKey];
            const keys = Object.keys(data).map(Number).sort((a, b) => a - b);

            // Cek apakah nilai di luar batas data (WHO hanya sampai 60 bulan)
            if (paramValue < keys[0]) return data[keys[0]];
            if (paramValue > keys[keys.length - 1]) return data[keys[keys.length - 1]];

            // Cari dua titik data terdekat
            let lowerKey = keys[0];
            let upperKey = keys[keys.length - 1];

            for (let i = 0; i < keys.length - 1; i++) {
                if (keys[i] <= paramValue && keys[i + 1] >= paramValue) {
                    lowerKey = keys[i];
                    upperKey = keys[i + 1];
                    break;
                }
            }

            // Jika nilai sama dengan salah satu titik kunci, kembalikan data tersebut
            if (lowerKey === upperKey) return data[lowerKey];

            const d1 = data[lowerKey];
            const d2 = data[upperKey];
            const interpolatedData = {};

            // Interpolasi untuk setiap nilai z-score
            for (const key in d1) {
                interpolatedData[key] = interpolate(paramValue, lowerKey, d1[key], upperKey, d2[key]);
            }

            return interpolatedData;
        }

        // Fungsi perhitungan Z-Score (Disederhanakan untuk data rujukan WHO)
        function getKategori(index, z) {
            let kategori, warna;
            let zScoreText = z.toFixed(2);

            if (index === "BB/U" || index === "BB/TB") {
                if (z < -3) { kategori = `Gizi Buruk / Sangat Kurus (Z: ${zScoreText})`; warna = "text-danger"; }
                else if (z < -2) { kategori = `Gizi Kurang / Kurus (Z: ${zScoreText})`; warna = "text-warning"; }
                else if (z <= 1) { kategori = `Gizi Baik (Z: ${zScoreText})`; warna = "text-success"; }
                else if (z <= 2) { kategori = `Gizi Lebih / Risiko Lebih (Z: ${zScoreText})`; warna = "text-info"; }
                else { kategori = `Obesitas (Z: ${zScoreText})`; warna = "text-primary"; }
            } else if (index === "TB/U") {
                if (z < -3) { kategori = `Sangat Pendek / Severe Stunting (Z: ${zScoreText})`; warna = "text-danger"; }
                else if (z < -2) { kategori = `Pendek / Stunting (Z: ${zScoreText})`; warna = "text-warning"; }
                else { kategori = `Tinggi Badan Normal (Z: ${zScoreText})`; warna = "text-success"; }
            } else {
                kategori = "Index Tidak Dikenal"; warna = "text-secondary";
            }
            return { kategori, warna, zScore: z };
        }


        /**
         * Fungsi untuk menampilkan modal error.
         * @param {string} message Pesan kesalahan yang akan ditampilkan.
         */
        function showErrorModal(message) {
            const errorMessageElement = document.getElementById('errorMessage');
            errorMessageElement.innerHTML = message;

            const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
            errorModal.show();
        }


        function hitungGizi() {
            const index = document.getElementById('kategoriIndex').value;
            const jenisKelamin = document.getElementById('jenisKelamin').value;
            const bb = parseFloat(document.getElementById('beratBadan').value);
            const tb = parseFloat(document.getElementById('tinggiBadan').value);
            const usia = parseInt(document.getElementById('usiaBulan').value);

            // Deklarasi variabel error di awal
            let errorMessage = '';

            // 1. Validasi Input Kosong/NaN
            if (!index || !jenisKelamin || isNaN(bb) || isNaN(tb) || isNaN(usia)) {
                errorMessage = "Harap lengkapi semua data input: Kategori Index, Jenis Kelamin, Berat Badan (kg), Tinggi Badan (cm), dan Usia (bulan).";
                showErrorModal(errorMessage);
                return;
            }

            let value, dataParam, dataWHOKey;

            if (index === "BB/U") {
                dataWHOKey = `${index}_${jenisKelamin}`;
                dataParam = usia;
                value = bb;
                if (usia < 0 || usia > 60) {
                    errorMessage = "BB/U hanya didukung untuk usia 0 hingga 60 bulan.";
                    showErrorModal(errorMessage);
                    return;
                }
            } else if (index === "TB/U") {
                dataWHOKey = `${index}_${jenisKelamin}`;
                dataParam = usia;
                value = tb;
                if (usia < 0 || usia > 60) {
                    errorMessage = "TB/U hanya didukung untuk usia 0 hingga 60 bulan.";
                    showErrorModal(errorMessage);
                    return;
                }
            } else if (index === "BB/TB") {
                dataWHOKey = `${index}_${jenisKelamin}`;
                dataParam = tb;
                value = bb;
                // Batasan yang lebih realistis
                if (tb < 45 || tb > 120) {
                    errorMessage = "BB/TB hanya didukung untuk Tinggi Badan 45 cm hingga 120 cm.";
                    showErrorModal(errorMessage);
                    return;
                }
            } else {
                errorMessage = "Kategori Index tidak valid.";
                showErrorModal(errorMessage);
                return;
            }

            // Dapatkan data rujukan WHO yang sudah diinterpolasi
            const whoData = getWhoData(dataWHOKey, dataParam);

            // Hitung Z-Score 
            let zScore;
            if (value >= whoData.median) {
                zScore = (value - whoData.median) / (whoData.sd1 - whoData.median);
            } else {
                zScore = (value - whoData.median) / (whoData.median - whoData.sd1neg);
            }


            // Ambil Kategori dan Warna
            const { kategori, warna } = getKategori(index, zScore);

            // --- Tampilkan Hasil di Modal ---
            const jkDisplay = jenisKelamin === 'L' ? 'Laki-laki' : 'Perempuan';
            const modalHeader = document.getElementById('hasilModalHeader');
            const modalTitleSpan = document.getElementById('jenisKelaminJudul');
            const kategoriHasil = document.getElementById('kategoriHasil');
            const grafikSubjudul = document.getElementById('grafikSubjudul');

            // *** START: PENAMBAHAN TANGGAL DAN JAM ***
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            //const waktuHitung = now.toLocaleDateString('id-ID', options);
            const waktuHitung = "15 Desember 2025";
            // *** END: PENAMBAHAN TANGGAL DAN JAM ***

            // Atur Warna Header Modal
            modalHeader.className = `modal-header text-white ${jenisKelamin === 'L' ? 'bg-laki-laki' : 'bg-perempuan'}`;
            modalTitleSpan.textContent = `- ${jkDisplay}`;

            // Atur Teks Hasil
            kategoriHasil.innerHTML = `Status Gizi Anak Anda (<span class="${warna}">${index}</span>) adalah: <br> <b class="${warna}">${kategori}</b>`;

            // Atur Subjudul Grafik (Tambahkan Waktu Hitung)
            const xLabel = index === "BB/TB" ? "Tinggi Badan (cm)" : "Usia (Bulan)";
            const yLabel = index === "TB/U" ? "Tinggi Badan (cm)" : "Berat Badan (kg)";

            // Perubahan di baris ini:
            grafikSubjudul.innerHTML = `Grafik Status Gizi Anak (<b>${index}</b>) berdasarkan ${xLabel}: <br><small class="text-muted fw-normal d-block mt-1">Dihitung pada: ${waktuHitung}</small>`;

            // Tampilkan Grafik
            tampilkanGrafik(index, dataParam, whoData, value, xLabel, yLabel, jenisKelamin);

            const hasilModal = new bootstrap.Modal(document.getElementById('hasilModal'));
            hasilModal.show();
        }


        // Fungsi untuk menampilkan grafik Z-Score
        function tampilkanGrafik(index, dataParam, whoData, value, xLabel, yLabel, jenisKelamin) {
            const ctx = document.getElementById('grafikZscore').getContext('2d');

            if (myChart) {
                myChart.destroy(); // Hancurkan chart lama jika ada
            }

            // Data untuk kurva Z-Score
            const labels = [
                `<-3 SD`, `-3 SD`, `-2 SD`, `-1 SD`,
                `Median`, // Z-Score 0
                `+1 SD`, `+2 SD`, `+3 SD`, `>+3 SD`
            ];

            const dataPoints = [
                whoData.sd3neg, whoData.sd3neg, whoData.sd2neg, whoData.sd1neg,
                whoData.median,
                whoData.sd1, whoData.sd2, whoData.sd3, whoData.sd3
            ];

            // Konfigurasi Chart
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        // Garis WHO Standard
                        {
                            label: `Rujukan WHO (${index})`,
                            data: dataPoints,
                            borderColor: '#8d8d8d',
                            backgroundColor: 'rgba(141, 141, 141, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: true,
                            tension: 0.2 // Untuk kurva yang lebih halus
                        },
                        // Titik Data Anak
                        {
                            label: `Data Anak (Z-Score ${getKategori(index, value >= whoData.median ? (value - whoData.median) / (whoData.sd1 - whoData.median) : (value - whoData.median) / (whoData.median - whoData.sd1neg)).zScore.toFixed(2)})`,
                            data: [
                                // Menemukan posisi horizontal yang paling mendekati nilai anak di sumbu Y
                                // Kita akan membuat titik anak sebagai Scatter-Plot di tengah, dan menggunakan anotasi
                                // untuk menunjukkan posisi vertikal anak
                            ],
                            type: 'scatter',
                            pointBackgroundColor: jenisKelamin === 'L' ? '#0d6efd' : '#e83e8c',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 8,
                            data: [{
                                x: 'Median', // Posisikan di label "Median" atau di tengah grafik
                                y: value
                            }],
                            showLine: false,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: yLabel
                            },
                            // Atur rentang Y agar titik anak terlihat jelas
                            min: Math.min(...dataPoints, value) * 0.9,
                            max: Math.max(...dataPoints, value) * 1.1,
                        },
                        x: {
                            title: {
                                display: true,
                                text: `Kurva Standar WHO Berdasarkan Z-Score (${xLabel}: ${dataParam} ${xLabel.includes("Bulan") ? 'bulan' : 'cm'})`
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    if (context.datasetIndex === 1) { // Titik data anak
                                        return `Nilai Anak: ${context.parsed.y.toFixed(2)} ${yLabel.includes("Berat") ? 'kg' : 'cm'}`;
                                    }
                                    return `Nilai Rujukan (${context.label}): ${context.parsed.y.toFixed(2)} ${yLabel.includes("Berat") ? 'kg' : 'cm'}`;
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>

</html>